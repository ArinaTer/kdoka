#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะดะตะฟะปะพั ัะพะฑัะฐะฝะฝะพะน ะฒะตััะธะธ ะฝะฐ ะฒะตัะบั main

echo "๐ ะะฐัะธะฝะฐะตะผ ะดะตะฟะปะพะน..."

# ะกะพััะฐะฝัะตะผ ัะตะบัััั ะฒะตัะบั
CURRENT_BRANCH=$(git branch --show-current)

# ะะตัะตะบะปััะฐะตะผัั ะฝะฐ ะฒะตัะบั dev
git checkout dev

# ะกะพะฑะธัะฐะตะผ ะฟัะพะตะบั
echo "๐ฆ ะกะพะฑะธัะฐะตะผ ะฟัะพะตะบั..."
npm run build

# ะัะพะฒะตััะตะผ, ััะพ ะฟะฐะฟะบะฐ dist ัะพะทะดะฐะปะฐัั
if [ ! -d "dist" ]; then
    echo "โ ะัะธะฑะบะฐ: ะฟะฐะฟะบะฐ dist ะฝะต ัะพะทะดะฐะปะฐัั ะฟะพัะปะต ัะฑะพัะบะธ"
    exit 1
fi

# ะะตัะตะบะปััะฐะตะผัั ะฝะฐ ะฒะตัะบั main
git checkout main

# ะฃะดะฐะปัะตะผ ััะฐััะต ัะฐะนะปั
echo "๐๏ธ ะฃะดะฐะปัะตะผ ััะฐััะต ัะฐะนะปั..."
git rm -rf dist/ 2>/dev/null || true

# ะะพะฟะธััะตะผ ัะพะฑัะฐะฝะฝัะต ัะฐะนะปั ะธะท dev ะฒะตัะบะธ
echo "๐ ะะพะฟะธััะตะผ ัะพะฑัะฐะฝะฝัะต ัะฐะนะปั..."
git checkout dev -- dist/ 2>/dev/null || echo "ะะต ัะดะฐะปะพัั ัะบะพะฟะธัะพะฒะฐัั dist ะธะท dev ะฒะตัะบะธ"

# ะะตัะตะผะตัะฐะตะผ ัะฐะนะปั ะธะท dist ะฒ ะบะพัะตะฝั
echo "๐ ะะตัะตะผะตัะฐะตะผ ัะฐะนะปั ะฒ ะบะพัะตะฝั..."
if [ -d "dist" ]; then
    # ะะตัะตะผะตัะฐะตะผ ะฒัะต ัะฐะนะปั ะธะท dist ะฒ ะบะพัะตะฝั
    mv dist/* . 2>/dev/null || true
    mv dist/.* . 2>/dev/null || true
    rmdir dist 2>/dev/null || true

    # ะะพะฑะฐะฒะปัะตะผ ัะพะปัะบะพ ะฝัะถะฝัะต ัะฐะนะปั (ะธัะบะปััะฐะตะผ node_modules ะธ ะดััะณะธะต)
    git add -f index.html assets/ 2>/dev/null || true
else
    echo "โ ะะฐะฟะบะฐ dist ะฝะต ะฝะฐะนะดะตะฝะฐ"
    exit 1
fi

# ะกะพะทะดะฐะตะผ ะบะพะผะผะธั
echo "๐พ ะกะพะทะดะฐะตะผ ะบะพะผะผะธั..."
git commit -m "Update production build - $(date)"

echo "โ ะะตะฟะปะพะน ะทะฐะฒะตััะตะฝ!"
echo "๐ ะขะตะบััะฐั ะฒะตัะบะฐ: $(git branch --show-current)"
echo "๐ ะคะฐะนะปั ะฒ dist/:"
ls -la dist/

# ะะพะทะฒัะฐัะฐะตะผัั ะฝะฐ ะธััะพะดะฝัั ะฒะตัะบั
if [ "$CURRENT_BRANCH" != "main" ]; then
    echo "๐ ะะพะทะฒัะฐัะฐะตะผัั ะฝะฐ ะฒะตัะบั $CURRENT_BRANCH..."
    git checkout $CURRENT_BRANCH
fi
